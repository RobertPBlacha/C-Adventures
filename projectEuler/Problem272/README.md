
# Problem 272
## Question
For a positive number $n$, define $C(n)$ as the number of the integers $x$, for which $1 < x < n$ and $x^3 \equiv 1 \mod n$.
When $n = 91$, there are $8$ possible values for $x$, namely: $9, 16, 22, 29, 53, 74, 79, 81$.  
Thus, $C(91) = 8$.
Find the sum of the positive numbers $n \leq 10^{11}$ for which $C(n) = 242$.
## Methodology  
### Definitions
For the following sections, let $P$ be the set of primes, $P_{+1} = \\{p \mid p\in P\wedge\exists k \in \mathbb{Z}$ s.t. $p  = 3k+1\\}$ and $P_{-1} = \\{p \mid p\in P\wedge\exists k \in \mathbb{Z}$ s.t. $p  = 3k-1\\}$. Let a set of groups $s = \{G_1, G_2, \dots, G_i\}$ be multiplicatively independent if $\forall G \in S \forall g \in G \nexists g' = g$ such that $g'$ is some product of elements of groups in $S$ that are not $G$ and $g'$ is not $1$.

### Deriving $C(n)$
Before diving in to the problem, it would be useful to be able to calculate $C(n)$ without searching through every number less than $n$ and checking if it fulfills the condition. The following section will ultimately prove that $C(n)$ is equivalent to $3^m - 1$ where $m$ is how many divisors $n$ has in the set of $\{9\}\cup P_{+1}$

#### Expressing C(n) in the form of counts of subgroups
We know that the answers of the congruency exist in $\mathbf{Z_n^\*}$, the group of all numbers coprime to $n$. We know this because $x^3 
\equiv 1 \mod n \implies x x^2 \equiv 1 \mod n$, meaning that $x$ has a multiplicative inverse under modulo $n$. This is only true when $gcd(x, n)$ is $1$. We can take this further, noting that $x$ generates a subgroup in $\mathbf{Z_n^\*}$, a cyclic group of the form ${1, x, x^2}$. Here we can first see that $x^2$ is also an answer: $x^3 \equiv 1 \mod n\implies (x^3)^2 \equiv1^2 \mod n$. 

> #### Lemma 1 All answers (including 1) form a group under multiplication. 
> *Proof*: A group requires closure, identity, inverse and associativity. Associativity is implied under multiplication and $1$ is the identity element for multiplication. We have already proven that the inverse of an answer is also an answer so all that is left to prove is closure. Let $a$ and $b$ be answers. $(a b)^3 \equiv a^3 b^3 \equiv 1^3 \times 1^3 \equiv 1 \mod n$. Therefore all these answers (including one) form a group.

What happens when there are two cyclic subgroups $\{1, a, a^2\}$ and $\{1, b, b^2\}$, that are multiplicatively independent? From these two cyclic subgroups we can generate a group of answers by lemma 1. This group has cardinality 9, each element in the group generated by $a$ is multiplied by each element in the group generated by $b$. Inductively as we add more multiplicatively independent cyclic subgroups of order $3$, our total number of answers will be multiplied by a factor of $3$.
 
#### How many multiplicatively independent cyclic subgroups of order $3$ are in $\mathbb{Z_n^\*}$
To find the number of multiplicatively independent cyclic subgroups of order $3$ in a group $\mathbb{Z_n^\*}$, let $n = p_1^{k_1}\times p_2^{k_2}\times ... \times p_i^{k_i}$ and apply the chinese remainder theorem to map $\mathbb{Z}\_n^\*$ to $\mathbb{Z}\_{p\_1^{k_1}}^\*$ $\times \mathbb{Z}\_{p\_2^{k_2}}^\* \times ...\times \mathbb{Z}\_{p\_i^{k_i}}^\*$ There are $3$ possible options for ways to express $p_i$, $p_i = 3$, $p_i = 3q - 1$, and $p_i = 3q + 1$ for some integer $q$.

Consider the case of $p_i = 3$. If $k_i = 1$, then $|Z_3^\*| = 2$, so there cannot exist a cyclic subgroup of order $3$. For $k_i > 1$, $|\mathbb{Z}\_{p_i^{k_i}}^\*| = 2 * 3^{k_1-1}$. We know that for odd prime $p$ all groups $\mathbb{Z}\_{p_i^{k_i}}^\*$ are cyclic and that there will be at most $\varphi(3)$ elements of order $3$ in each group. Combining these three elements with $1$, which will always be in these groups, results in a group of order $3$ when $3^{k_i}$ divides $n$ where $k_i > 1$. This is equivalent to saying that $9 \mid n$.  

Next, consider the case of $p_i = 3q+1$ where $q$ is an integer. Then $|\mathbb{Z}\_{p_i^{k_i}}^\*| = (p_i - 1) * p_i^{k_i-1}$. We know that $3 \mid (p_i - 1) * p_i^{k_i-1}$ because $3 \mid (3q) * (3q+1)^{k_i-1}$. Similarly we know that the group $\mathbb{Z}\_{p_i^{k_i}}^\*$ is cyclic so there will be exactly $\varphi(3) = 2$ elements whose order is $3$ who form a cyclic subgroup of order $3$ with $1$.

Finally, consider the case the case where $p_i = 3q - 1$ where q is an integer. We know that $3 \nmid (p_i - 1) * p_i^{k_i-1}$ because $p\nmid (3q - 2)$ and $3\nmid p_i^{k_i-1}$ because $p_i$ is a prime not equal to $3$. The only element that will satisfy $x^3 \equiv 1$ will be $1$ in these groups.

Because $\mathbb{Z}\_n^\* \cong \mathbb{Z}\_{{p_1}^{k_1}}^\*\times\mathbb{Z\_{{p_2}^{k_2}}^\*}\times...\times\mathbb{Z}\_{{p_i}^{k_i}}^\*$, the number of elements $e$ where $e^3 \equiv 1 \mod n$ in the group $\mathbb{Z}\_n^\*$ will be equal to the number of tuples who are entirely comprised of elements $e_1, e_2, \dots, e_i$ where all $e_i^3 \equiv 1 \mod p_i^{k_i}$. This is $1$ when $3 \nmid p_i - 1$ and $3$ when $3 \mid p_i - 1$. The group $\mathbb{Z}\_{3^{k_i}}^\*$ will have $3$ elements if $k_i > 1$ and $1$ if not. The answer does not include $1$ to be counted as a solution, so all answers will be of the form $3^m - 1$ for some integer $m$.

Therefore $C(n)$ is equivalent to $3^m - 1$ where $m$ is how many divisors $n$ has in the set of $\{9\}\cup P_{+1}\blacksquare$

### Finding all primes of the form $3q+1 < 10^{11}$, and solving the problem
#### Segmented Sieve of Eratosthenes
The most efficient way to find primes is the Sieve of Eratosthenes, which has time complexity $O(n log(log(n))$. The Sieve works by zero initializing an array of numbers whose index corresponds to their values, and after skipping indexes $0$ and $1$, marking $0$ entries as prime and updating the list. To update the list you mark all multiples of the newly discovered prime as non zero. Even after assuming each bit can be represented as a number, a sieve for all numbers less than $10^{11}$ would require $\frac{10^{11}}{8}$ bytes or roughly $11.6$ GB of continuous memory, which is impractical.
A segmented sieve breaks up the range into segments, which evenly fit into the cpu's L1 cache for optimal memory access time. To do this, first a list of every possible divisor of numbers less than $10^{11}$ can be determined so that the segmented sieve does not need to spuriously check new primes. At least one divisor (that is not one) of a number less than $10^{11}$ must be less than the square root of $10^{11}$, an array of chars for this range of numbers is only roughly 300 KB of memory, which is reasonable. These list of divisors can be used on the segments of numbers less than $10^{11}$, so that only a portion of the total numbers take up memory at any given time. Another benefit of finding all divisors first is that it then prevents the calculation of segments from depending on one another, allowing for multithreading without the need for mutexes or message passing.
We can therefore use a segmented sieve of Erathosthenes to generate all primes below $10^{11}$ who are one more than a multiple of three. Because we only care for answers where $C(n) = 3^5 - 1$, we only need to find primes less than $\frac{10^{11}}{9(7)(13)(19)}$, as any number greater than this will not factor an $n$ less than $10^{11}$ where $C(n) = 3^5 - 1$. 
#### Finding C(n) for any given number 
To find all $n < 10^{11}$ where $C(n) = 3^5 - 1$, a modified sieve of Erathosthenes can be used. Instead of marking a number as prime or not, the sieve will calculate $C(n)$ for every number by each index storing the number of divisors $n$ has in the set described in the first section. The list of divisors are the primes discovered earlier (and $9$). Whenever a divisor divides $n$, increase its value in the array by $1$. When going through the segment after updating with all of the discovered primes, any $n$ that has $5$ in its index will have $C(n) = 242$. Instead of saving $n$ to a list, merely keep a running sum of all $n$. This can be multithreaded the same way as the last sieve and is the last step to solving the problem efficiently.
## Code
https://github.com/RobertPBlacha/C-Adventures/blob/main/projectEuler/Problem272/Problem272.c
## Answer

    gcc Problem272.c -O3 && time ./a.out && rm ./a.out
    ANSWER: 8495585919506151122
  
    real    0m30.356s
	user    8m35.108s
	sys     0m0.040s


